package malwaremanager

import (
	"os"
	"strings"
	"time"

	"github.com/kubescape/node-agent/pkg/malwaremanager"
	malwaremanager2 "github.com/kubescape/node-agent/pkg/malwaremanager/v1/types"
	"github.com/kubescape/node-agent/pkg/utils"

	"github.com/armosec/armoapi-go/armotypes"
	"github.com/dustin/go-humanize"
	"github.com/dutchcoders/go-clamd"
	"github.com/inspektor-gadget/inspektor-gadget/pkg/gadgets/trace/open/types"
	"github.com/kubescape/go-logger"
	"github.com/kubescape/go-logger/helpers"
	"golang.org/x/sys/unix"
)

func (c *ClamAVClient) handleOpenEvent(event *types.Event, containerPid uint32) malwaremanager.MalwareResult {
	if event == nil {
		return nil
	}

	// discard if it is an open for writing event
	if event.FlagsRaw&unix.O_WRONLY != 0 {
		return nil
	}

	hostFilePath, err := utils.GetHostFilePathFromEvent(event, containerPid)
	if err != nil {
		logger.L().Error("Error getting host file path", helpers.Error(err))
		return nil
	}

	response, err := c.clamd.ScanFile(hostFilePath)
	if err != nil {
		logger.L().Error("Error scanning file", helpers.Error(err))
		return nil
	}

	for result := range response {
		if result.Status == clamd.RES_FOUND {
			// A malware was found, send an alert.
			size, err := utils.GetFileSize(result.Path)
			if err != nil {
				logger.L().Error("Error getting file size of %s", helpers.String("path", result.Path), helpers.Error(err))
			}

			sha1hash := ""
			md5hash := ""
			if size != 0 && size < maxFileSize {
				sha1hash, md5hash, err = utils.CalculateFileHashes(result.Path)
				if err != nil {
					logger.L().Error("Error getting file hashes", helpers.Error(err))
				}
			}
			path := strings.TrimPrefix(result.Path, os.Getenv("HOST_ROOT"))

			return &malwaremanager2.GenericMalwareResult{
				BasicRuntimeAlert: armotypes.BaseRuntimeAlert{
					AlertName:      result.Description,
					InfectedPID:    event.Pid,
					FixSuggestions: FixSuggestions,
					SHA1Hash:       sha1hash,
					MD5Hash:        md5hash,
					Severity:       10, // TODO: Get severity from api.
					Size:           humanize.IBytes(uint64(size)),
					Timestamp:      time.Unix(0, int64(event.Timestamp)),
				},
				RuntimeProcessDetails: armotypes.ProcessTree{
					ProcessTree: armotypes.Process{
						Comm: event.Comm,
						Path: path,
						Gid:  &event.Gid,
						PID:  event.Pid,
						Uid:  &event.Uid,
					},
					ContainerID: event.Runtime.ContainerID,
				},
				TriggerEvent: event.Event,
				MalwareRuntimeAlert: armotypes.MalwareAlert{
					MalwareDescription: result.Description,
				},
				RuntimeAlertK8sDetails: armotypes.RuntimeAlertK8sDetails{
					ContainerID:   event.Runtime.ContainerID,
					ContainerName: event.K8s.ContainerName,
					Namespace:     event.GetNamespace(),
					PodName:       event.GetPod(),
					PodNamespace:  event.GetNamespace(),
					HostNetwork:   &event.K8s.HostNetwork,
					Image:         event.Runtime.ContainerImageName,
					ImageDigest:   event.Runtime.ContainerImageDigest,
				},
			}
		}
	}

	return nil
}
